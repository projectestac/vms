#!/bin/bash

# Call example: ./vm

function clone_project {
    project=$1
    branch=$2
    dir=$3
    giturl=git@github.com:IOC/$project.git
    clone_project_git "$project" "$giturl" "$branch" "$dir"
}

function clone_project_git {
    project=$1
    giturl=$2
    branch=$3
    dir=$4
    homedir=$(pwd)
    if [ ! -d "$homedir/../$dir" ]; then
        echo "Project $project not found, cloning branch $branch in directory $dir..."
        git clone "$giturl" "$homedir/../$dir"
        if [[ "$branch" != "master" ]]; then
            pushd "$homedir/../$dir" || return
            git checkout -b "$branch" "origin/$branch"
            popd || return
        fi
        pushd "$homedir/../$dir" || return
        git submodule update --recursive --init
        popd || return
    fi
}

# vms branch
git pull origin ioc-moodle

if ! vagrant plugin list | grep -q vagrant-hosts; then
    vagrant plugin install vagrant-hosts
fi

if ! vagrant plugin list | grep -q vagrant-disksize; then
    vagrant plugin install vagrant-disksize
fi

# Moodle branch
clone_project moodle35 master moodle

vagrant box update

echo "Starting the VM"
vagrant up --provider virtualbox
