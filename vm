#!/bin/bash

# Call example: ./vm

function clone_project {
    project=$1
    branch=$2
    giturl=git@github.com:projectestac/$project.git
    clone_project_git $project $giturl $branch
}

function clone_project_git {
    project=$1
    giturl=$2
    branch=$3
    homedir=`pwd`
    if [ ! -d "$homedir/../$project" ]; then
        echo "Project $project not found, cloning..."
        git clone $giturl $homedir/../$project
        pushd "$homedir/../$project"
        git checkout -b $branch origin/$branch
        popd
        pushd $homedir/../$project
        git submodule update --recursive --init
        popd
    fi
}

git pull

if [ -z "$(vagrant plugin list | grep vagrant-hosts)" ]; then
    vagrant plugin install vagrant-hosts
fi

if [ -z "$(vagrant plugin list | grep vagrant-disksize)" ]; then
    vagrant plugin install vagrant-disksize
fi

clone_project odissea aws

vagrant box update

echo "Starting the VM"
vagrant up --provider virtualbox
